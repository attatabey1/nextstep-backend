{% extends "base.html" %}
{% load i18n %}
{% load pages_extras %}
{% load static %}

{% block title %}
  {% trans "Gallery" %} • SCHOLARIFY
{% endblock %}

{% block content %}
<!-- Hero Section -->
<section class="relative bg-gradient-to-br from-primary-50/30 via-white to-secondary-50/20">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pt-8 pb-6">
    <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-6">
      <div class="flex-1">
        <!-- Breadcrumb -->
        <nav class="mb-4" aria-label="Breadcrumb">
          <ol class="flex items-center space-x-2 text-sm text-slate-600">
            <li>
              <a href="/" class="hover:text-primary-600 transition-colors">{% trans "Home" %}</a>
            </li>
            <li class="flex items-center">
              <i class="fas fa-chevron-right mx-2 text-xs text-slate-400"></i>
            </li>
            <li class="text-primary-700 font-semibold" aria-current="page">
              {% trans "Gallery" %}
            </li>
          </ol>
        </nav>

        <!-- Title -->
        <h1 class="text-3xl sm:text-4xl lg:text-5xl font-black tracking-tight text-slate-900 leading-tight">
          {% trans "Our" %} <span class="gradient-text">{% trans "Gallery" %}</span>
        </h1>
        
        <p class="mt-3 text-lg text-slate-600 max-w-3xl">
          {% trans "Explore success stories, events, partnerships, and inspiring moments from our community." %}
        </p>

        <!-- Stats -->
        <div class="mt-6 flex flex-wrap items-center gap-6">
          <div class="flex items-center gap-2">
            <div class="h-3 w-3 rounded-full bg-primary-500 animate-pulse-slow"></div>
            <div class="text-sm text-slate-700">
              <span class="font-bold text-slate-900">{{ images|length }}</span>
              {% trans "images" %}
            </div>
          </div>
          
          <div class="flex items-center gap-2">
            <i class="fas fa-heart text-rose-500 text-sm"></i>
            <div class="text-sm text-slate-700">
              <span class="font-bold text-slate-900">{{ total_likes }}</span>
              {% trans "total likes" %}
            </div>
          </div>
          
          <div class="flex items-center gap-2">
            <i class="fas fa-eye text-emerald-500 text-sm"></i>
            <div class="text-sm text-slate-700">
              <span class="font-bold text-slate-900">{{ total_views }}</span>
              {% trans "total views" %}
            </div>
          </div>
        </div>
      </div>

      <!-- Upload Button (Admin Only) -->
      {% if user.is_staff %}
      <div class="lg:text-right">
        <a href="{% url 'admin:pages_galleryimage_add' %}" 
           class="inline-flex items-center gap-2 px-6 py-3.5 rounded-xl bg-gradient-to-r from-primary-600 to-secondary-600 
                  text-white font-bold hover:from-primary-700 hover:to-secondary-700 
                  hover:shadow-lg transition-all duration-300 shadow-md">
          <i class="fas fa-cloud-upload-alt"></i>
          {% trans "Upload Image" %}
        </a>
        <p class="text-xs text-slate-500 mt-2">{% trans "Admin only • Max 5MB per image" %}</p>
      </div>
      {% endif %}
    </div>
  </div>
</section>

<!-- Gallery Grid -->
<main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  {% if images %}
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
    {% for g in images %}
    <article class="group bg-white rounded-2xl border border-slate-200 shadow-lg hover:shadow-xl transition-all duration-300 overflow-hidden">
      <!-- Image Container -->
      <div class="relative overflow-hidden">
        <button
          type="button"
          class="w-full h-64 relative overflow-hidden focus:outline-none"
          data-url="{{ g.image.url }}"
          data-title="{{ g.title|default:'' }}"
          data-caption="{{ g.caption|default:'' }}"
          onclick="openModal(this)"
          aria-label="{% trans 'View image' %}">
          
          <!-- Main Image -->
          <img src="{{ g.image.url }}" alt="{{ g.title }}" 
               class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110">
          
          <!-- Overlay with smooth animation -->
          <div class="absolute inset-0 bg-gradient-to-t from-black/50 via-black/20 to-transparent opacity-0 
                      group-hover:opacity-100 transition-all duration-500 flex items-end p-4">
            <div class="text-white transform translate-y-4 group-hover:translate-y-0 transition-transform duration-500">
              <div class="font-semibold text-lg mb-1">
                {% if g.title %}{{ g.title }}{% else %}{% trans "Untitled" %}{% endif %}
              </div>
              <div class="text-sm text-white/90">
                <i class="far fa-calendar mr-1"></i>
                {{ g.created_at|date:"M d, Y" }}
              </div>
            </div>
          </div>
        </button>
        
        <!-- SINGLE Download Button - Top Right (Always Visible) -->
        <button class="absolute top-3 right-3 h-10 w-10 rounded-xl bg-white/90 backdrop-blur-sm flex items-center justify-center 
                       shadow-md hover:bg-white hover:shadow-lg hover:scale-110 transition-all duration-300
                       border border-slate-200 hover:border-primary-300"
                onclick="event.stopPropagation(); downloadImage('{{ g.image.url }}', '{{ g.title|default:"gallery_image"|escapejs }}');"
                aria-label="{% trans 'Download' %}"
                title="{% trans 'Download Image' %}">
          <i class="fas fa-download text-primary-600 text-sm"></i>
        </button>
        
        <!-- Like Count Badge -->
        <div class="absolute top-3 left-3">
          <div class="px-3 py-1.5 rounded-full bg-white/90 backdrop-blur-sm flex items-center gap-1.5 shadow-sm">
            <i class="fas fa-heart text-rose-500 text-xs"></i>
            <span id="like-count-{{ g.id }}" class="text-sm font-semibold text-slate-900">
              {{ likes_count|get_item:g.id|default:0 }}
            </span>
          </div>
        </div>
      </div>
      
      <!-- Content -->
      <div class="p-5">
        <!-- Title and Caption -->
        <div class="mb-4">
          <h3 class="text-lg font-bold text-slate-900 mb-2 line-clamp-2">
            {% if g.title %}{{ g.title }}{% else %}{% trans "Untitled" %}{% endif %}
          </h3>
          {% if g.caption %}
          <p class="text-sm text-slate-600 line-clamp-3">{{ g.caption }}</p>
          {% endif %}
        </div>
        
        <!-- Action Buttons - View and Like Only -->
        <div class="flex items-center gap-3">
          <!-- View Button -->
          <button
            type="button"
            class="flex-1 inline-flex items-center justify-center gap-2 px-4 py-2.5 rounded-xl border border-slate-200 
                   bg-white text-slate-700 font-medium hover:bg-slate-50 hover:border-primary-300 
                   hover:text-primary-700 transition-all duration-300"
            data-url="{{ g.image.url }}"
            data-title="{{ g.title|default:'' }}"
            data-caption="{{ g.caption|default:'' }}"
            onclick="openModal(this)">
            <i class="fas fa-expand text-slate-600"></i>
            <span>{% trans "View" %}</span>
          </button>
          
          <!-- Like Button -->
          <button type="button"
                  class="flex-1 inline-flex items-center justify-center gap-2 px-4 py-2.5 rounded-xl 
                         {% if g.id in liked_ids %}bg-rose-50 border-rose-200 text-rose-700{% else %}border border-slate-200 bg-white text-slate-700{% endif %} 
                         font-medium hover:bg-rose-50 hover:border-rose-300 hover:text-rose-700 
                         transition-all duration-300"
                  onclick="toggleLike('{{ g.id }}', this)">
            <i class="fas fa-heart {% if g.id in liked_ids %}text-rose-500{% else %}text-slate-500{% endif %}"></i>
            <span id="like-text-{{ g.id }}">
              {% if g.id in liked_ids %}{% trans "Liked" %}{% else %}{% trans "Like" %}{% endif %}
            </span>
          </button>
        </div>
      </div>
    </article>
    {% endfor %}
  </div>
  {% else %}
  <!-- Empty State -->
  <div class="py-16 text-center">
    <div class="max-w-md mx-auto">
      <div class="inline-flex h-24 w-24 rounded-2xl bg-gradient-to-br from-slate-100 to-slate-200 
                  items-center justify-center mb-6">
        <i class="fas fa-images text-slate-400 text-3xl"></i>
      </div>
      
      <h3 class="text-2xl font-bold text-slate-900 mb-3">{% trans "No Images Yet" %}</h3>
      
      <p class="text-slate-600 mb-8">
        {% trans "The gallery is currently empty. Check back soon for updates or contact the administrator." %}
      </p>
      
      {% if user.is_staff %}
      <a href="{% url 'admin:pages_galleryimage_add' %}" 
         class="inline-flex items-center gap-2 px-6 py-3 rounded-xl bg-gradient-to-r from-primary-600 to-secondary-600 
                text-white font-semibold hover:from-primary-700 hover:to-secondary-700 
                hover:shadow-lg transition-all duration-300">
        <i class="fas fa-plus"></i>
        {% trans "Upload First Image" %}
      </a>
      {% endif %}
    </div>
  </div>
  {% endif %}
</main>

<!-- MODAL -->
<div id="imgModal" class="fixed inset-0 hidden z-50 animate-fade-in">
  <!-- Backdrop -->
  <div class="absolute inset-0 bg-black/90 backdrop-blur-sm" onclick="closeModal()"></div>
  
  <!-- Modal Container -->
  <div class="relative h-full w-full flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl overflow-hidden shadow-2xl w-full max-w-6xl">
      <!-- Header -->
      <div class="flex items-center justify-between p-6 border-b border-slate-200">
        <div class="flex-1 min-w-0">
          <div id="modalTitle" class="text-xl font-bold text-slate-900 truncate"></div>
          <div id="modalCaption" class="text-sm text-slate-600 mt-1 line-clamp-2"></div>
        </div>
        
        <div class="flex items-center gap-3">
          <!-- Download Button in Modal -->
          <button onclick="downloadCurrentImage()"
                  class="inline-flex items-center gap-2 px-4 py-2.5 rounded-xl bg-gradient-to-r from-primary-600 to-secondary-600 
                         text-white font-medium hover:from-primary-700 hover:to-secondary-700 
                         hover:shadow-lg transition-all duration-300">
            <i class="fas fa-download"></i>
            <span>{% trans "Download" %}</span>
          </button>
          
          <!-- Close Button -->
          <button class="h-10 w-10 rounded-xl border border-slate-200 bg-white text-slate-700 
                         hover:bg-slate-50 hover:border-primary-300 hover:text-primary-700 
                         transition-all duration-300 flex items-center justify-center"
                  onclick="closeModal()"
                  aria-label="{% trans 'Close' %}">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>
      
      <!-- Image Container -->
      <div class="bg-slate-50 flex items-center justify-center p-4 min-h-[400px] max-h-[70vh] overflow-auto">
        <img id="modalImg" src="" alt="" 
             class="max-w-full max-h-full object-contain rounded-lg shadow-lg transition-opacity duration-500" />
      </div>
      
      <!-- Footer Actions -->
      <div class="p-6 border-t border-slate-200 bg-white">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <a id="modalOpen" class="inline-flex items-center gap-2 px-5 py-2.5 rounded-xl border border-slate-200 
                     bg-white text-slate-700 font-medium hover:bg-slate-50 hover:border-primary-300 
                     hover:text-primary-700 transition-all duration-300"
               href="#" target="_blank" rel="noopener">
              <i class="fas fa-external-link-alt"></i>
              {% trans "Open Original" %}
            </a>
            
            <button id="modalLikeBtn"
                    class="inline-flex items-center gap-2 px-5 py-2.5 rounded-xl border border-slate-200 
                           bg-white text-slate-700 font-medium hover:bg-rose-50 hover:border-rose-300 
                           hover:text-rose-700 transition-all duration-300">
              <i class="far fa-heart"></i>
              <span>{% trans "Like" %}</span>
            </button>
          </div>
          
          <!-- Navigation -->
          <div class="flex items-center gap-2">
            <button id="prevBtn" class="h-10 w-10 rounded-xl border border-slate-200 bg-white text-slate-700 
                         hover:bg-slate-50 hover:border-primary-300 hover:text-primary-700 
                         transition-all duration-300 flex items-center justify-center"
                    onclick="navigateModal(-1)">
              <i class="fas fa-chevron-left"></i>
            </button>
            <button id="nextBtn" class="h-10 w-10 rounded-xl border border-slate-200 bg-white text-slate-700 
                         hover:bg-slate-50 hover:border-primary-300 hover:text-primary-700 
                         transition-all duration-300 flex items-center justify-center"
                    onclick="navigateModal(1)">
              <i class="fas fa-chevron-right"></i>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Global variables
  let currentImageIndex = -1;
  const galleryImages = [
    {% for g in images %}
    {
      id: '{{ g.id }}',
      url: '{{ g.image.url }}',
      title: '{{ g.title|default:""|escapejs }}',
      caption: '{{ g.caption|default:""|escapejs }}',
      likeUrl: '{% url "pages:gallery-like" g.id %}',
      likes: {{ likes_count|get_item:g.id|default:0 }},
      liked: {% if g.id in liked_ids %}true{% else %}false{% endif %}
    },
    {% endfor %}
  ];

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(";");
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + "=")) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  function openModal(element) {
    const url = element.getAttribute('data-url');
    const title = element.getAttribute('data-title') || '';
    const caption = element.getAttribute('data-caption') || '';
    
    // Find the image index
    currentImageIndex = galleryImages.findIndex(img => img.url === url);
    
    updateModalContent(currentImageIndex);
    
    const modal = document.getElementById("imgModal");
    modal.classList.remove("hidden");
    document.body.style.overflow = 'hidden';
  }

  function updateModalContent(index) {
    if (index < 0 || index >= galleryImages.length) return;
    
    const img = galleryImages[index];
    const modalImg = document.getElementById("modalImg");
    const modalTitle = document.getElementById("modalTitle");
    const modalCaption = document.getElementById("modalCaption");
    const modalOpen = document.getElementById("modalOpen");
    const modalLikeBtn = document.getElementById("modalLikeBtn");
    
    // Fade in effect for image
    modalImg.style.opacity = '0';
    setTimeout(() => {
      modalImg.src = img.url;
      modalImg.alt = img.title || "{% trans 'Gallery image' %}";
      modalImg.style.opacity = '1';
    }, 150);
    
    modalTitle.textContent = img.title || "{% trans 'Untitled' %}";
    modalCaption.textContent = img.caption || "";
    modalOpen.href = img.url;
    
    // Update like button
    modalLikeBtn.innerHTML = img.liked ? 
      '<i class="fas fa-heart text-rose-500"></i><span>{% trans "Liked" %}</span>' : 
      '<i class="far fa-heart"></i><span>{% trans "Like" %}</span>';
    modalLikeBtn.onclick = () => toggleLikeInModal(img.id, modalLikeBtn);
    
    // Update navigation buttons
    document.getElementById("prevBtn").style.visibility = index > 0 ? "visible" : "hidden";
    document.getElementById("nextBtn").style.visibility = index < galleryImages.length - 1 ? "visible" : "hidden";
  }

  function navigateModal(direction) {
    const newIndex = currentImageIndex + direction;
    if (newIndex >= 0 && newIndex < galleryImages.length) {
      currentImageIndex = newIndex;
      updateModalContent(currentImageIndex);
    }
  }

  function closeModal() {
    const modal = document.getElementById("imgModal");
    modal.classList.add("hidden");
    document.getElementById("modalImg").src = "";
    document.body.style.overflow = '';
    currentImageIndex = -1;
  }

  async function toggleLike(imageId, button) {
    event.stopPropagation();
    
    const image = galleryImages.find(img => img.id === imageId);
    if (!image) return;
    
    const url = image.likeUrl;
    const likeCountSpan = document.getElementById(`like-count-${imageId}`);
    const likeTextSpan = document.getElementById(`like-text-${imageId}`);
    
    try {
      const res = await fetch(url, {
        method: 'POST',
        headers: {
          'X-CSRFToken': getCookie('csrftoken'),
          'X-Requested-With': 'XMLHttpRequest',
        },
      });

      if (!res.ok) throw new Error('Network response was not ok');

      const data = await res.json();
      
      // Update local data
      image.likes = data.likes;
      image.liked = data.liked;
      
      // Update UI
      if (likeCountSpan) likeCountSpan.textContent = data.likes;
      if (likeTextSpan) likeTextSpan.textContent = data.liked ? "{% trans 'Liked' %}" : "{% trans 'Like' %}";
      
      if (button) {
        // Smooth transition for like button
        if (data.liked) {
          button.classList.remove('border-slate-200', 'bg-white', 'text-slate-700');
          button.classList.add('bg-rose-50', 'border-rose-200', 'text-rose-700');
          button.querySelector('i').className = 'fas fa-heart text-rose-500';
          
          // Heart animation
          button.style.transform = 'scale(1.1)';
          setTimeout(() => {
            button.style.transform = 'scale(1)';
          }, 300);
        } else {
          button.classList.remove('bg-rose-50', 'border-rose-200', 'text-rose-700');
          button.classList.add('border-slate-200', 'bg-white', 'text-slate-700');
          button.querySelector('i').className = 'fas fa-heart text-slate-500';
        }
      }
      
      // Update modal if open
      if (currentImageIndex >= 0 && galleryImages[currentImageIndex].id === imageId) {
        updateModalContent(currentImageIndex);
      }
    } catch (error) {
      console.error('Error liking image:', error);
    }
  }

  async function toggleLikeInModal(imageId, button) {
    await toggleLike(imageId, button);
  }

  function downloadImage(url, filename) {
    event.stopPropagation();
    
    // Show downloading feedback
    const button = event.target.closest('button');
    if (button) {
      const originalHTML = button.innerHTML;
      button.innerHTML = '<i class="fas fa-spinner fa-spin text-primary-600 text-sm"></i>';
      button.disabled = true;
      
      setTimeout(() => {
        button.innerHTML = originalHTML;
        button.disabled = false;
      }, 1000);
    }
    
    // Create download link
    const link = document.createElement('a');
    link.href = url;
    link.download = filename || url.split('/').pop();
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    // Show success message
    showToast('{% trans "Download started" %}');
  }

  function downloadCurrentImage() {
    if (currentImageIndex >= 0) {
      const img = galleryImages[currentImageIndex];
      const filename = img.title ? `${img.title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.jpg` : 'gallery_image.jpg';
      downloadImage(img.url, filename);
    }
  }

  function showToast(message) {
    // Remove existing toast
    const existingToast = document.querySelector('.download-toast');
    if (existingToast) {
      existingToast.remove();
    }
    
    // Create new toast
    const toast = document.createElement('div');
    toast.className = 'download-toast fixed bottom-4 left-1/2 transform -translate-x-1/2 px-4 py-2.5 rounded-lg bg-slate-800 text-white text-sm font-medium shadow-lg z-50 opacity-0 animate-toast-in';
    toast.textContent = message;
    document.body.appendChild(toast);
    
    // Remove toast after 3 seconds
    setTimeout(() => {
      toast.classList.remove('animate-toast-in');
      toast.classList.add('animate-toast-out');
      setTimeout(() => {
        if (toast.parentNode) {
          toast.remove();
        }
      }, 300);
    }, 3000);
  }

  // Keyboard navigation
  document.addEventListener('keydown', function(event) {
    if (event.key === "Escape") closeModal();
    if (!document.getElementById("imgModal").classList.contains("hidden")) {
      if (event.key === "ArrowLeft") navigateModal(-1);
      if (event.key === "ArrowRight") navigateModal(1);
    }
  });

  // Initialize gallery
  document.addEventListener('DOMContentLoaded', function() {
    // Add click animation to cards
    document.querySelectorAll('.group').forEach(card => {
      card.addEventListener('click', function(e) {
        if (!e.target.closest('button') && e.target.tagName !== 'IMG') {
          this.style.transform = 'scale(0.98)';
          setTimeout(() => {
            this.style.transform = '';
          }, 200);
        }
      });
    });
    
    // Preload images for smoother hover
    const images = document.querySelectorAll('img');
    images.forEach(img => {
      img.addEventListener('load', function() {
        this.style.opacity = '1';
      });
    });
  });
</script>

<style>
  /* Slower animations */
  .animate-pulse-slow {
    animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
  }
  
  @keyframes pulse {
    0%, 100% {
      opacity: 1;
    }
    50% {
      opacity: 0.5;
    }
  }
  
  .animate-fade-in {
    animation: fadeIn 0.5s ease-out;
  }
  
  @keyframes fadeIn {
    from { 
      opacity: 0; 
      transform: translateY(10px) scale(0.98);
    }
    to { 
      opacity: 1; 
      transform: translateY(0) scale(1);
    }
  }
  
  /* Toast animations */
  @keyframes toastIn {
    from { 
      opacity: 0; 
      transform: translate(-50%, 20px); 
    }
    to { 
      opacity: 1; 
      transform: translate(-50%, 0); 
    }
  }
  
  @keyframes toastOut {
    from { 
      opacity: 1; 
      transform: translate(-50%, 0); 
    }
    to { 
      opacity: 0; 
      transform: translate(-50%, 20px); 
    }
  }
  
  .animate-toast-in {
    animation: toastIn 0.3s ease-out forwards;
  }
  
  .animate-toast-out {
    animation: toastOut 0.3s ease-in forwards;
  }
  
  /* Image hover effect */
  .group:hover img {
    transition: transform 0.7s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  /* Download button hover effect */
  button:hover {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  /* Line clamping */
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  
  .line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  
  /* Image loading */
  img {
    transition: opacity 0.5s ease;
  }
  
  /* Ensure download button is always visible and properly sized */
  .absolute.top-3.right-3 {
    z-index: 10;
  }
  
  /* Make download icon clearly visible */
  .fa-download {
    font-size: 14px;
  }
  
  /* Responsive adjustments */
  @media (max-width: 640px) {
    .line-clamp-2 {
      -webkit-line-clamp: 1;
    }
    
    .line-clamp-3 {
      -webkit-line-clamp: 2;
    }
  }
</style>
{% endblock %}